{"version":3,"file":"KPZlR0ib.min.js","names":["res: Response","timeoutId: number","autocomplete: HTMLElement | null","autocompleteList: HTMLUListElement | null"],"sources":["../../../../../client/simple/src/js/main/autocomplete.ts"],"sourcesContent":["// SPDX-License-Identifier: AGPL-3.0-or-later\r\n\r\nimport { http, listen, settings } from \"../toolkit.ts\";\r\nimport { assertElement } from \"../util/assertElement.ts\";\r\n\r\nconst fetchResults = async (qInput: HTMLInputElement, query: string): Promise<void> => {\r\n  try {\r\n    let res: Response;\r\n\r\n    if (settings.method === \"GET\") {\r\n      res = await http(\"GET\", `./autocompleter?q=${query}`);\r\n    } else {\r\n      res = await http(\"POST\", \"./autocompleter\", { body: new URLSearchParams({ q: query }) });\r\n    }\r\n\r\n    const results = await res.json();\r\n\r\n    const autocomplete = document.querySelector<HTMLElement>(\".autocomplete\");\r\n    assertElement(autocomplete);\r\n\r\n    const autocompleteList = document.querySelector<HTMLUListElement>(\".autocomplete ul\");\r\n    assertElement(autocompleteList);\r\n\r\n    autocomplete.classList.add(\"open\");\r\n    autocompleteList.replaceChildren();\r\n\r\n    // show an error message that no result was found\r\n    if (results?.[1]?.length === 0) {\r\n      const noItemFoundMessage = Object.assign(document.createElement(\"li\"), {\r\n        className: \"no-item-found\",\r\n        textContent: settings.translations?.no_item_found ?? \"No results found\"\r\n      });\r\n      autocompleteList.append(noItemFoundMessage);\r\n      return;\r\n    }\r\n\r\n    const fragment = new DocumentFragment();\r\n\r\n    for (const result of results[1]) {\r\n      const li = Object.assign(document.createElement(\"li\"), { textContent: result });\r\n\r\n      listen(\"mousedown\", li, () => {\r\n        qInput.value = result;\r\n\r\n        const form = document.querySelector<HTMLFormElement>(\"#search\");\r\n        form?.submit();\r\n\r\n        autocomplete.classList.remove(\"open\");\r\n      });\r\n\r\n      fragment.append(li);\r\n    }\r\n\r\n    autocompleteList.append(fragment);\r\n  } catch (error) {\r\n    console.error(\"Error fetching autocomplete results:\", error);\r\n  }\r\n};\r\n\r\nconst qInput = document.getElementById(\"q\") as HTMLInputElement | null;\r\nassertElement(qInput);\r\n\r\nlet timeoutId: number;\r\n\r\nlisten(\"input\", qInput, () => {\r\n  clearTimeout(timeoutId);\r\n\r\n  const query = qInput.value;\r\n  const minLength = settings.autocomplete_min ?? 2;\r\n\r\n  if (query.length < minLength) return;\r\n\r\n  timeoutId = window.setTimeout(async () => {\r\n    if (query === qInput.value) {\r\n      await fetchResults(qInput, query);\r\n    }\r\n  }, 300);\r\n});\r\n\r\nconst autocomplete: HTMLElement | null = document.querySelector<HTMLElement>(\".autocomplete\");\r\nconst autocompleteList: HTMLUListElement | null = document.querySelector<HTMLUListElement>(\".autocomplete ul\");\r\nif (autocompleteList) {\r\n  listen(\"keyup\", qInput, (event: KeyboardEvent) => {\r\n    const listItems = [...autocompleteList.children] as HTMLElement[];\r\n\r\n    const currentIndex = listItems.findIndex((item) => item.classList.contains(\"active\"));\r\n    let newCurrentIndex = -1;\r\n\r\n    switch (event.key) {\r\n      case \"ArrowUp\": {\r\n        const currentItem = listItems[currentIndex];\r\n        if (currentItem && currentIndex >= 0) {\r\n          currentItem.classList.remove(\"active\");\r\n        }\r\n        // we need to add listItems.length to the index calculation here because the JavaScript modulos\r\n        // operator doesn't work with negative numbers\r\n        newCurrentIndex = (currentIndex - 1 + listItems.length) % listItems.length;\r\n        break;\r\n      }\r\n      case \"ArrowDown\": {\r\n        const currentItem = listItems[currentIndex];\r\n        if (currentItem && currentIndex >= 0) {\r\n          currentItem.classList.remove(\"active\");\r\n        }\r\n        newCurrentIndex = (currentIndex + 1) % listItems.length;\r\n        break;\r\n      }\r\n      case \"Tab\":\r\n      case \"Enter\":\r\n        if (autocomplete) {\r\n          autocomplete.classList.remove(\"open\");\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (newCurrentIndex !== -1) {\r\n      const selectedItem = listItems[newCurrentIndex];\r\n      if (selectedItem) {\r\n        selectedItem.classList.add(\"active\");\r\n\r\n        if (!selectedItem.classList.contains(\"no-item-found\")) {\r\n          const qInput = document.getElementById(\"q\") as HTMLInputElement | null;\r\n          if (qInput) {\r\n            qInput.value = selectedItem.textContent ?? \"\";\r\n          }\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n"],"mappings":"4FAKA,IAAM,EAAe,MAAO,EAA0B,IAAiC,CACrF,GAAI,CACF,IAAIA,EAEJ,AAGE,EAHE,EAAS,SAAW,MAChB,MAAM,EAAK,MAAO,qBAAqB,IAAQ,CAE/C,MAAM,EAAK,OAAQ,kBAAmB,CAAE,KAAM,IAAI,gBAAgB,CAAE,EAAG,EAAO,CAAC,CAAE,CAAC,CAG1F,IAAM,EAAU,MAAM,EAAI,MAAM,CAE1B,EAAe,SAAS,cAA2B,gBAAgB,CACzE,EAAc,EAAa,CAE3B,IAAM,EAAmB,SAAS,cAAgC,mBAAmB,CAOrF,GANA,EAAc,EAAiB,CAE/B,EAAa,UAAU,IAAI,OAAO,CAClC,EAAiB,iBAAiB,CAG9B,IAAU,IAAI,SAAW,EAAG,CAC9B,IAAM,EAAqB,OAAO,OAAO,SAAS,cAAc,KAAK,CAAE,CACrE,UAAW,gBACX,YAAa,EAAS,cAAc,eAAiB,mBACtD,CAAC,CACF,EAAiB,OAAO,EAAmB,CAC3C,OAGF,IAAM,EAAW,IAAI,iBAErB,IAAK,IAAM,KAAU,EAAQ,GAAI,CAC/B,IAAM,EAAK,OAAO,OAAO,SAAS,cAAc,KAAK,CAAE,CAAE,YAAa,EAAQ,CAAC,CAE/E,EAAO,YAAa,MAAU,CAC5B,EAAO,MAAQ,EAEF,SAAS,cAA+B,UAAU,EACzD,QAAQ,CAEd,EAAa,UAAU,OAAO,OAAO,EACrC,CAEF,EAAS,OAAO,EAAG,CAGrB,EAAiB,OAAO,EAAS,OAC1B,EAAO,CACd,QAAQ,MAAM,uCAAwC,EAAM,GAI1D,EAAS,SAAS,eAAe,IAAI,CAC3C,EAAc,EAAO,CAErB,IAAIC,EAEJ,EAAO,QAAS,MAAc,CAC5B,aAAa,EAAU,CAEvB,IAAM,EAAQ,EAAO,MACf,EAAY,EAAS,kBAAoB,EAE3C,EAAM,OAAS,IAEnB,EAAY,OAAO,WAAW,SAAY,CACpC,IAAU,EAAO,OACnB,MAAM,EAAa,EAAQ,EAAM,EAElC,IAAI,GACP,CAEF,IAAMC,EAAmC,SAAS,cAA2B,gBAAgB,CACvFC,EAA4C,SAAS,cAAgC,mBAAmB,CAC1G,GACF,EAAO,QAAS,EAAS,GAAyB,CAChD,IAAM,EAAY,CAAC,GAAG,EAAiB,SAAS,CAE1C,EAAe,EAAU,UAAW,GAAS,EAAK,UAAU,SAAS,SAAS,CAAC,CACjF,EAAkB,GAEtB,OAAQ,EAAM,IAAd,CACE,IAAK,UAAW,CACd,IAAM,EAAc,EAAU,GAC1B,GAAe,GAAgB,GACjC,EAAY,UAAU,OAAO,SAAS,CAIxC,GAAmB,EAAe,EAAI,EAAU,QAAU,EAAU,OACpE,MAEF,IAAK,YAAa,CAChB,IAAM,EAAc,EAAU,GAC1B,GAAe,GAAgB,GACjC,EAAY,UAAU,OAAO,SAAS,CAExC,GAAmB,EAAe,GAAK,EAAU,OACjD,MAEF,IAAK,MACL,IAAK,QACC,GACF,EAAa,UAAU,OAAO,OAAO,CAEvC,MACF,QACE,MAGJ,GAAI,IAAoB,GAAI,CAC1B,IAAM,EAAe,EAAU,GAC/B,GAAI,IACF,EAAa,UAAU,IAAI,SAAS,CAEhC,CAAC,EAAa,UAAU,SAAS,gBAAgB,EAAE,CACrD,IAAM,EAAS,SAAS,eAAe,IAAI,CACvC,IACF,EAAO,MAAQ,EAAa,aAAe,OAKnD"}